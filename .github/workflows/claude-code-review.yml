name: Cursor Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]

jobs:
    code-review:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Install Cursor CLI
              run: |
                  curl https://cursor.com/install -fsS | bash
                  echo "$HOME/.cursor/bin" >> $GITHUB_PATH

            - name: Perform code review
              env:
                  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
                  GH_TOKEN: ${{ github.token }}
              run: |
                  cursor-agent --force --output-format=text --print "You are performing automated code review in GitHub Actions. The gh CLI is available and authenticated.

                  Context:
                  - Repo: ${{ github.repository }}
                  - PR Number: ${{ github.event.pull_request.number }}
                  - PR Head SHA: ${{ github.event.pull_request.head.sha }}
                  - PR Base SHA: ${{ github.event.pull_request.base.sha }}

                  Objectives:
                  1) Review the PR diff and flag clear, high-severity issues
                  2) Leave short inline comments (1-2 sentences) on changed lines
                  3) Provide a brief summary at the end

                  Procedure:
                  - Get diff: gh pr diff
                  - Check existing comments: gh pr view --json comments

                  Rules:
                  - Max 10 inline comments; prioritize critical issues
                  - One issue per comment on the exact changed line
                  - Use emojis: üö® Critical üîí Security ‚ö° Performance ‚ö†Ô∏è Logic ‚ú® Suggestion

                  Submit review with: gh pr review --comment"
